<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6366f1">
    <title>PDF Master - Professional PDF Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/downloadjs/1.4.8/download.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        /* Dark Theme (Default) */
        [data-theme="dark"] {
            --background: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(255,255,255,0.1);
            --glass: rgba(30, 41, 59, 0.8);
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --input-bg: #0f172a;
            --hover-bg: rgba(255,255,255,0.1);
            --card-bg: #1e293b;
        }

        /* Light Theme */
        [data-theme="light"] {
            --background: #f8fafc;
            --surface: #ffffff;
            --surface-light: #e2e8f0;
            --text: #0f172a;
            --text-muted: #64748b;
            --border: rgba(0,0,0,0.1);
            --glass: rgba(255, 255, 255, 0.8);
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            --input-bg: #f1f5f9;
            --hover-bg: rgba(0,0,0,0.05);
            --card-bg: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(236, 72, 153, 0.15) 0%, transparent 50%);
            animation: bgPulse 10s ease-in-out infinite;
            transition: opacity 0.3s;
        }

        [data-theme="light"] .bg-animation {
            opacity: 0.5;
        }

        @keyframes bgPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Header */
        .header {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo i {
            font-size: 1.5rem;
            -webkit-text-fill-color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Upload Area - Fixed for Android */
        .upload-zone {
            border: 2px dashed var(--surface-light);
            border-radius: 24px;
            padding: 3rem 2rem;
            text-align: center;
            background: var(--surface);
            transition: all 0.3s ease;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .upload-zone:active {
            transform: scale(0.98);
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.5s;
            opacity: 0;
        }

        .upload-zone.active::before {
            animation: shimmer 1.5s infinite;
            opacity: 1;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .upload-zone.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .upload-text {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text);
            pointer-events: none;
        }

        .upload-subtext {
            color: var(--text-muted);
            font-size: 0.875rem;
            pointer-events: none;
        }

        .file-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 10;
        }

        /* Feature Grid */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .feature-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 1.5rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }

        .feature-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent, var(--hover-bg));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .feature-card:hover::after {
            opacity: 1;
        }

        .feature-card:active {
            transform: scale(0.95);
        }

        .feature-card.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        .feature-card.merge { border-top: 3px solid #3b82f6; }
        .feature-card.split { border-top: 3px solid #10b981; }
        .feature-card.edit { border-top: 3px solid #f59e0b; }
        .feature-card.compress { border-top: 3px solid #8b5cf6; }
        .feature-card.convert { border-top: 3px solid #ec4899; }
        .feature-card.protect { border-top: 3px solid #ef4444; }

        .feature-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            display: block;
        }

        .feature-card.merge .feature-icon { color: #3b82f6; }
        .feature-card.split .feature-icon { color: #10b981; }
        .feature-card.edit .feature-icon { color: #f59e0b; }
        .feature-card.compress .feature-icon { color: #8b5cf6; }
        .feature-card.convert .feature-icon { color: #ec4899; }
        .feature-card.protect .feature-icon { color: #ef4444; }

        .feature-title {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text);
        }

        .feature-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* PDF Preview Area */
        .pdf-workspace {
            background: var(--surface);
            border-radius: 24px;
            padding: 1.5rem;
            min-height: 400px;
            display: none;
            border: 1px solid var(--border);
        }

        .pdf-workspace.active {
            display: block;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .workspace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .pdf-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .pdf-thumbnail {
            width: 60px;
            height: 80px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .pdf-details h3 {
            font-size: 1.125rem;
            margin-bottom: 0.25rem;
            color: var(--text);
        }

        .pdf-details p {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .workspace-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Page Thumbnails Grid */
        .pages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .page-item {
            background: var(--background);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            aspect-ratio: 1/1.4;
        }

        .page-item:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
        }

        .page-item.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        .page-item.merging {
            border-color: #3b82f6;
            animation: pulse 2s infinite;
        }

        .page-number {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .page-checkbox {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--surface);
            border: 2px solid var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .page-item.selected .page-checkbox {
            background: var(--primary);
            border-color: var(--primary);
        }

        .page-checkbox i {
            font-size: 0.75rem;
            opacity: 0;
            color: white;
        }

        .page-item.selected .page-checkbox i {
            opacity: 1;
        }

        .page-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: white;
        }

        /* Action Panel */
        .action-panel {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            display: none;
        }

        [data-theme="light"] .action-panel {
            background: var(--input-bg);
        }

        .action-panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .panel-title {
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
        }

        .range-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-group label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .input-group input, .input-group select {
            background: var(--input-bg);
            border: 1px solid var(--surface-light);
            border-radius: 8px;
            padding: 0.75rem;
            color: var(--text);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            border: none;
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            background: var(--surface-light);
            color: var(--text);
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::after {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--hover-bg);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error), #dc2626);
            color: white;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 24px;
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            animation: slideUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: var(--hover-bg);
            color: var(--text);
        }

        /* Progress Bar */
        .progress-container {
            display: none;
            margin: 1rem 0;
        }

        .progress-container.active {
            display: block;
        }

        .progress-bar {
            height: 8px;
            background: var(--surface-light);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: progressShimmer 1.5s infinite;
        }

        @keyframes progressShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            width: 90%;
            max-width: 400px;
        }

        .toast {
            background: var(--surface);
            color: var(--text);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideInRight 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--error); }
        .toast.warning { border-left-color: var(--warning); }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--surface-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background);
            opacity: 0.95;
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1rem;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-text {
            color: var(--text);
            font-size: 1.125rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .features-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .pages-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .workspace-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .range-inputs {
                grid-template-columns: 1fr;
            }
        }

        /* Text Editor Overlay */
        .text-editor {
            background: var(--background);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid var(--border);
        }

        .toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .toolbar-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--surface);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }

        .toolbar-btn:hover {
            background: var(--primary);
            color: white;
        }

        .editor-content {
            min-height: 200px;
            background: var(--input-bg);
            color: var(--text);
            padding: 1rem;
            border-radius: 8px;
            outline: none;
            border: 1px solid var(--border);
        }

        /* Password Input */
        .password-strength {
            height: 4px;
            background: var(--surface-light);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            width: 0;
            transition: all 0.3s;
            border-radius: 2px;
        }

        .strength-weak { width: 33%; background: var(--error); }
        .strength-medium { width: 66%; background: var(--warning); }
        .strength-strong { width: 100%; background: var(--success); }

        /* Recent Files */
        .recent-files {
            margin-top: 2rem;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text);
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .file-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--border);
        }

        .file-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
            background: var(--hover-bg);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-meta h4 {
            font-size: 0.9375rem;
            margin-bottom: 0.25rem;
            color: var(--text);
        }

        .file-meta p {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Mobile Bottom Sheet */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-radius: 24px 24px 0 0;
            padding: 1.5rem;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1500;
            max-height: 80vh;
            overflow-y: auto;
            border-top: 1px solid var(--border);
        }

        .bottom-sheet.active {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            background: var(--surface-light);
            border-radius: 2px;
            margin: 0 auto 1.5rem;
        }

        .sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 1400;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .sheet-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body data-theme="dark">
    <div class="bg-animation"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">Processing PDF...</div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Header -->
    <header class="header">
        <div class="logo">
            <i class="fas fa-file-pdf"></i>
            <span>PDF Master</span>
        </div>
        <div class="header-actions">
            <button class="btn btn-icon btn-secondary" onclick="showHelp()" title="Help">
                <i class="fas fa-question"></i>
            </button>
            <button class="btn btn-icon btn-secondary" onclick="toggleTheme()" title="Toggle Theme" id="themeBtn">
                <i class="fas fa-sun"></i>
            </button>
        </div>
    </header>

    <div class="container">
        <!-- Upload Zone - Fixed for Android -->
        <div class="upload-zone" id="uploadZone">
            <i class="fas fa-cloud-upload-alt upload-icon"></i>
            <div class="upload-text">Tap to browse files</div>
            <div class="upload-subtext">Supports PDF up to 50MB</div>
            <input type="file" class="file-input" id="fileInput" accept=".pdf,application/pdf" multiple>
        </div>

        <!-- Features Grid -->
        <div class="features-grid" id="featuresGrid" style="display: none;">
            <div class="feature-card merge" onclick="selectFeature('merge')">
                <i class="fas fa-object-group feature-icon"></i>
                <div class="feature-title">Merge PDFs</div>
                <div class="feature-desc">Combine multiple files</div>
            </div>
            <div class="feature-card split" onclick="selectFeature('split')">
                <i class="fas fa-cut feature-icon"></i>
                <div class="feature-title">Split PDF</div>
                <div class="feature-desc">Extract pages</div>
            </div>
            <div class="feature-card edit" onclick="selectFeature('edit')">
                <i class="fas fa-edit feature-icon"></i>
                <div class="feature-title">Edit PDF</div>
                <div class="feature-desc">Modify content</div>
            </div>
            <div class="feature-card compress" onclick="selectFeature('compress')">
                <i class="fas fa-compress-alt feature-icon"></i>
                <div class="feature-title">Compress</div>
                <div class="feature-desc">Reduce file size</div>
            </div>
            <div class="feature-card convert" onclick="selectFeature('convert')">
                <i class="fas fa-exchange-alt feature-icon"></i>
                <div class="feature-title">Convert</div>
                <div class="feature-desc">To/From images</div>
            </div>
            <div class="feature-card protect" onclick="selectFeature('protect')">
                <i class="fas fa-lock feature-icon"></i>
                <div class="feature-title">Protect</div>
                <div class="feature-desc">Password & security</div>
            </div>
        </div>

        <!-- PDF Workspace -->
        <div class="pdf-workspace" id="pdfWorkspace">
            <div class="workspace-header">
                <div class="pdf-info">
                    <div class="pdf-thumbnail">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="pdf-details">
                        <h3 id="pdfName">document.pdf</h3>
                        <p id="pdfStats">0 pages • 0 KB</p>
                    </div>
                </div>
                <div class="workspace-actions">
                    <button class="btn btn-secondary" onclick="clearWorkspace()">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button class="btn btn-primary" onclick="processAction()">
                        <i class="fas fa-magic"></i> Apply Changes
                    </button>
                </div>
            </div>

            <!-- Dynamic Action Panel -->
            <div class="action-panel" id="actionPanel">
                <div class="panel-header">
                    <div class="panel-title" id="panelTitle">
                        <i class="fas fa-cut"></i> Split PDF
                    </div>
                </div>
                <div id="panelContent">
                    <!-- Dynamic content based on selected feature -->
                </div>
            </div>

            <!-- Pages Grid -->
            <div class="pages-grid" id="pagesGrid"></div>
        </div>

        <!-- Recent Files -->
        <div class="recent-files" id="recentFiles">
            <div class="section-title">
                <i class="fas fa-history"></i>
                Recent Files
            </div>
            <div class="file-list" id="fileList">
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <p>No recent files</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Sheet for Mobile -->
    <div class="sheet-overlay" id="sheetOverlay" onclick="closeBottomSheet()"></div>
    <div class="bottom-sheet" id="bottomSheet">
        <div class="sheet-handle"></div>
        <div id="sheetContent"></div>
    </div>

    <script>
        // Global State
        let currentPDF = null;
        let pdfBytes = null;
        let selectedPages = new Set();
        let currentFeature = null;
        let pdfFiles = [];
        let isDarkTheme = true;
        let isProcessing = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            loadRecentFiles();
            checkTheme();
        });

        function setupEventListeners() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            // Remove any existing listeners by cloning
            const newFileInput = fileInput.cloneNode(true);
            fileInput.parentNode.replaceChild(newFileInput, fileInput);
            
            // Re-get reference after cloning
            const freshFileInput = document.getElementById('fileInput');

            // Android-friendly click handling
            uploadZone.addEventListener('click', (e) => {
                if (!isProcessing && e.target !== freshFileInput) {
                    freshFileInput.click();
                }
            });

            // Touch events for Android
            uploadZone.addEventListener('touchstart', (e) => {
                if (!isProcessing) {
                    uploadZone.style.transform = 'scale(0.98)';
                }
            }, {passive: true});

            uploadZone.addEventListener('touchend', (e) => {
                uploadZone.style.transform = 'scale(1)';
                if (!isProcessing) {
                    setTimeout(() => {
                        freshFileInput.click();
                    }, 50);
                }
            }, {passive: true});

            // File input change - CRITICAL FIX
            freshFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0 && !isProcessing) {
                    handleFiles(e.target.files);
                    // Reset input immediately after getting files
                    setTimeout(() => {
                        e.target.value = '';
                    }, 100);
                }
            });

            // Drag and drop (desktop)
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                if (!isProcessing) {
                    handleFiles(e.dataTransfer.files);
                }
            });
        }

        async function handleFiles(files) {
            if (files.length === 0 || isProcessing) return;

            const file = files[0];
            if (file.type !== 'application/pdf' && !file.name.endsWith('.pdf')) {
                showToast('Please upload a PDF file', 'error');
                return;
            }

            isProcessing = true;
            showLoading(true);
            
            try {
                // CRITICAL FIX: Clone the array buffer to prevent detachment
                const originalBuffer = await file.arrayBuffer();
                const clonedBuffer = originalBuffer.slice(0); // This creates a copy
                
                // Store cloned bytes
                pdfBytes = new Uint8Array(clonedBuffer);
                
                // Load PDF using cloned buffer
                const pdf = await pdfjsLib.getDocument({ data: clonedBuffer.slice(0) }).promise;
                currentPDF = pdf;
                
                // Store file info with cloned data
                const fileData = {
                    name: file.name,
                    size: file.size,
                    pages: pdf.numPages,
                    date: new Date(),
                    data: Array.from(pdfBytes) // Store as regular array for JSON
                };
                
                // Add to recent files
                addToRecentFiles(fileData);
                
                displayPDFInfo(file, pdf.numPages);
                await renderPageThumbnails(pdf);
                showWorkspace();
                
                document.getElementById('featuresGrid').style.display = 'grid';
                showToast(`Loaded ${file.name} successfully`, 'success');
            } catch (error) {
                console.error('PDF Load Error:', error);
                showToast('Error loading PDF: ' + error.message, 'error');
                // Reset state on error
                currentPDF = null;
                pdfBytes = null;
            } finally {
                showLoading(false);
                isProcessing = false;
            }
        }

        function addToRecentFiles(fileData) {
            try {
                let recent = JSON.parse(localStorage.getItem('recentPDFs') || '[]');
                
                // Remove duplicate if exists
                recent = recent.filter(f => f.name !== fileData.name);
                
                // Add to beginning
                recent.unshift(fileData);
                
                // Keep only last 5
                recent = recent.slice(0, 5);
                
                localStorage.setItem('recentPDFs', JSON.stringify(recent));
                loadRecentFiles();
            } catch (e) {
                console.error('Error saving to recent:', e);
            }
        }

        function displayPDFInfo(file, numPages) {
            document.getElementById('pdfName').textContent = file.name;
            const sizeKB = (file.size / 1024).toFixed(1);
            document.getElementById('pdfStats').textContent = `${numPages} pages • ${sizeKB} KB`;
        }

        async function renderPageThumbnails(pdf) {
            const grid = document.getElementById('pagesGrid');
            grid.innerHTML = '';
            selectedPages.clear();

            for (let i = 1; i <= pdf.numPages; i++) {
                try {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 0.5 });
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;

                    const pageItem = document.createElement('div');
                    pageItem.className = 'page-item';
                    pageItem.dataset.page = i;
                    
                    // Better touch handling for page selection
                    pageItem.addEventListener('click', (e) => {
                        e.preventDefault();
                        togglePageSelection(i);
                    });

                    const img = document.createElement('img');
                    img.src = canvas.toDataURL();
                    img.className = 'page-preview';

                    const checkbox = document.createElement('div');
                    checkbox.className = 'page-checkbox';
                    checkbox.innerHTML = '<i class="fas fa-check"></i>';

                    const pageNum = document.createElement('div');
                    pageNum.className = 'page-number';
                    pageNum.textContent = `Page ${i}`;

                    pageItem.appendChild(img);
                    pageItem.appendChild(checkbox);
                    pageItem.appendChild(pageNum);
                    grid.appendChild(pageItem);
                } catch (err) {
                    console.error(`Error rendering page ${i}:`, err);
                }
            }
        }

        function togglePageSelection(pageNum) {
            const pageItem = document.querySelector(`.page-item[data-page="${pageNum}"]`);
            
            if (selectedPages.has(pageNum)) {
                selectedPages.delete(pageNum);
                pageItem.classList.remove('selected');
            } else {
                selectedPages.add(pageNum);
                pageItem.classList.add('selected');
            }

            updateActionPanel();
        }

        function selectFeature(feature) {
            currentFeature = feature;
            
            // Update UI
            document.querySelectorAll('.feature-card').forEach(card => {
                card.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            updateActionPanel();
            showToast(`${feature.charAt(0).toUpperCase() + feature.slice(1)} mode activated`, 'success');
        }

        function updateActionPanel() {
            const panel = document.getElementById('actionPanel');
            const title = document.getElementById('panelTitle');
            const content = document.getElementById('panelContent');

            if (!currentFeature) return;

            panel.classList.add('active');

            switch(currentFeature) {
                case 'merge':
                    title.innerHTML = '<i class="fas fa-object-group"></i> Merge PDFs';
                    content.innerHTML = `
                        <p style="margin-bottom: 1rem; color: var(--text-muted);">
                            Add another PDF to merge with the current one
                        </p>
                        <input type="file" accept=".pdf,application/pdf" id="mergeFile" style="display: none;" onchange="handleMergeFile(this)">
                        <button class="btn btn-secondary" onclick="document.getElementById('mergeFile').click()" style="width: 100%;">
                            <i class="fas fa-plus"></i> Add PDF to Merge
                        </button>
                        <div id="mergeList" style="margin-top: 1rem;"></div>
                    `;
                    break;

                case 'split':
                    title.innerHTML = '<i class="fas fa-cut"></i> Split PDF';
                    content.innerHTML = `
                        <p style="margin-bottom: 1rem; color: var(--text-muted);">
                            Select pages to extract or specify range
                        </p>
                        <div class="range-inputs">
                            <div class="input-group">
                                <label>From Page</label>
                                <input type="number" id="splitFrom" min="1" max="${currentPDF.numPages}" value="1">
                            </div>
                            <div class="input-group">
                                <label>To Page</label>
                                <input type="number" id="splitTo" min="1" max="${currentPDF.numPages}" value="${currentPDF.numPages}">
                            </div>
                        </div>
                        <p style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-muted);">
                            ${selectedPages.size > 0 ? `Selected ${selectedPages.size} pages manually` : 'Or click pages above to select individually'}
                        </p>
                    `;
                    break;

                case 'edit':
                    title.innerHTML = '<i class="fas fa-edit"></i> Edit PDF';
                    content.innerHTML = `
                        <div class="text-editor">
                            <div class="toolbar">
                                <button class="toolbar-btn" onclick="formatText('bold')"><i class="fas fa-bold"></i></button>
                                <button class="toolbar-btn" onclick="formatText('italic')"><i class="fas fa-italic"></i></button>
                                <button class="toolbar-btn" onclick="formatText('underline')"><i class="fas fa-underline"></i></button>
                                <button class="toolbar-btn" onclick="addText()"><i class="fas fa-font"></i></button>
                                <button class="toolbar-btn" onclick="addImage()"><i class="fas fa-image"></i></button>
                            </div>
                            <div class="editor-content" contenteditable="true" id="editorContent">
                                Click here to edit text content...
                            </div>
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-muted);">
                            Note: This is a demo. Full PDF editing requires server-side processing.
                        </p>
                    `;
                    break;

                case 'compress':
                    title.innerHTML = '<i class="fas fa-compress-alt"></i> Compress PDF';
                    content.innerHTML = `
                        <p style="margin-bottom: 1rem; color: var(--text-muted);">
                            Reduce file size while maintaining quality
                        </p>
                        <div class="input-group" style="margin-bottom: 1rem;">
                            <label>Quality Level</label>
                            <select id="compressLevel" style="width: 100%; padding: 0.75rem; border-radius: 8px; background: var(--input-bg); color: var(--text); border: 1px solid var(--surface-light);">
                                <option value="low">Low Compression (Better Quality)</option>
                                <option value="medium" selected>Medium Compression (Balanced)</option>
                                <option value="high">High Compression (Smaller Size)</option>
                            </select>
                        </div>
                        <div style="background: var(--input-bg); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: var(--text-muted);">Current Size</span>
                                <span id="currentSize" style="color: var(--text);">-</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; color: var(--success);">
                                <span>Estimated Size</span>
                                <span id="estimatedSize">-</span>
                            </div>
                        </div>
                    `;
                    break;

                case 'convert':
                    title.innerHTML = '<i class="fas fa-exchange-alt"></i> Convert PDF';
                    content.innerHTML = `
                        <p style="margin-bottom: 1rem; color: var(--text-muted);">
                            Convert PDF to other formats
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                            <button class="btn btn-secondary" onclick="convertTo('jpg')">
                                <i class="fas fa-image"></i> To JPG
                            </button>
                            <button class="btn btn-secondary" onclick="convertTo('png')">
                                <i class="fas fa-image"></i> To PNG
                            </button>
                            <button class="btn btn-secondary" onclick="convertTo('word')">
                                <i class="fas fa-file-word"></i> To Word
                            </button>
                            <button class="btn btn-secondary" onclick="convertTo('text')">
                                <i class="fas fa-file-alt"></i> To Text
                            </button>
                        </div>
                    `;
                    break;

                case 'protect':
                    title.innerHTML = '<i class="fas fa-lock"></i> Protect PDF';
                    content.innerHTML = `
                        <p style="margin-bottom: 1rem; color: var(--text-muted);">
                            Add password protection
                        </p>
                        <div class="input-group" style="margin-bottom: 1rem;">
                            <label>Password</label>
                            <input type="password" id="pdfPassword" placeholder="Enter password" oninput="checkPasswordStrength(this.value)" style="background: var(--input-bg); color: var(--text);">
                            <div class="password-strength">
                                <div class="password-strength-bar" id="passwordStrength"></div>
                            </div>
                        </div>
                        <div class="input-group" style="margin-bottom: 1rem;">
                            <label>Confirm Password</label>
                            <input type="password" id="confirmPassword" placeholder="Confirm password" style="background: var(--input-bg); color: var(--text);">
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="checkbox" id="allowPrinting" checked style="width: 18px; height: 18px;">
                            <label for="allowPrinting" style="font-size: 0.875rem; color: var(--text);">Allow printing</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="allowCopying" style="width: 18px; height: 18px;">
                            <label for="allowCopying" style="font-size: 0.875rem; color: var(--text);">Allow copying text</label>
                        </div>
                    `;
                    break;
            }
        }

        async function processAction() {
            if (!currentFeature || !pdfBytes) {
                showToast('Please select a feature first', 'warning');
                return;
            }

            showLoading(true);

            try {
                // CRITICAL FIX: Clone bytes before processing to prevent detachment
                const bytesCopy = new Uint8Array(pdfBytes);
                const pdfDoc = await PDFLib.PDFDocument.load(bytesCopy);
                let modifiedPdf = pdfDoc;
                let fileName = 'modified.pdf';

                switch(currentFeature) {
                    case 'split':
                        if (selectedPages.size > 0) {
                            const newPdf = await PDFLib.PDFDocument.create();
                            const pages = Array.from(selectedPages).sort((a, b) => a - b);
                            const copiedPages = await newPdf.copyPages(pdfDoc, pages.map(p => p - 1));
                            copiedPages.forEach(page => newPdf.addPage(page));
                            modifiedPdf = newPdf;
                            fileName = 'split.pdf';
                        } else {
                            const from = parseInt(document.getElementById('splitFrom').value);
                            const to = parseInt(document.getElementById('splitTo').value);
                            const newPdf = await PDFLib.PDFDocument.create();
                            const pageIndices = [];
                            for (let i = from; i <= to; i++) pageIndices.push(i - 1);
                            const copiedPages = await newPdf.copyPages(pdfDoc, pageIndices);
                            copiedPages.forEach(page => newPdf.addPage(page));
                            modifiedPdf = newPdf;
                            fileName = `pages_${from}-${to}.pdf`;
                        }
                        break;

                    case 'protect':
                        const password = document.getElementById('pdfPassword').value;
                        const confirmPass = document.getElementById('confirmPassword').value;
                        if (password !== confirmPass) {
                            showToast('Passwords do not match', 'error');
                            showLoading(false);
                            return;
                        }
                        if (password.length < 4) {
                            showToast('Password must be at least 4 characters', 'error');
                            showLoading(false);
                            return;
                        }
                        
                        modifiedPdf = await PDFLib.PDFDocument.create();
                        const copiedPages = await modifiedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                        copiedPages.forEach(page => modifiedPdf.addPage(page));
                        
                        const permissions = {
                            printing: document.getElementById('allowPrinting').checked ? 'highResolution' : 'none',
                            copying: document.getElementById('allowCopying').checked,
                            modifying: false,
                        };
                        
                        modifiedPdf.encrypt({
                            userPassword: password,
                            ownerPassword: password,
                            permissions: permissions
                        });
                        fileName = 'protected.pdf';
                        break;

                    case 'merge':
                        showToast('Please use the Add PDF button to merge files', 'warning');
                        showLoading(false);
                        return;

                    case 'compress':
                        const level = document.getElementById('compressLevel').value;
                        showToast(`Compression simulation: ${level} quality`, 'success');
                        break;

                    case 'edit':
                        showToast('Text editing requires server processing in full implementation', 'warning');
                        showLoading(false);
                        return;
                }

                if (currentFeature !== 'compress') {
                    const newBytes = await modifiedPdf.save();
                    download(newBytes, fileName, 'application/pdf');
                    showToast(`${currentFeature} completed successfully!`, 'success');
                }
            } catch (error) {
                console.error(error);
                showToast('Error processing PDF: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Helper Functions
        function showWorkspace() {
            document.getElementById('uploadZone').style.display = 'none';
            document.getElementById('recentFiles').style.display = 'none';
            document.getElementById('pdfWorkspace').classList.add('active');
        }

        function clearWorkspace() {
            currentPDF = null;
            pdfBytes = null;
            selectedPages.clear();
            currentFeature = null;
            
            document.getElementById('uploadZone').style.display = 'block';
            document.getElementById('featuresGrid').style.display = 'none';
            document.getElementById('pdfWorkspace').classList.remove('active');
            document.getElementById('actionPanel').classList.remove('active');
            document.getElementById('recentFiles').style.display = 'block';
            
            // CRITICAL FIX: Properly reset file input
            const fileInput = document.getElementById('fileInput');
            fileInput.value = '';
            
            // Re-setup listeners to ensure clean state
            setupEventListeners();
            
            document.querySelectorAll('.feature-card').forEach(card => {
                card.classList.remove('active');
            });
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            toast.innerHTML = `
                <i class="fas fa-${icons[type]}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function checkPasswordStrength(password) {
            const bar = document.getElementById('passwordStrength');
            if (!bar) return;
            
            bar.className = 'password-strength-bar';
            
            if (password.length < 6) {
                bar.classList.add('strength-weak');
            } else if (password.length < 10) {
                bar.classList.add('strength-medium');
            } else {
                bar.classList.add('strength-strong');
            }
        }

        function formatText(command) {
            document.execCommand(command, false, null);
        }

        function addText() {
            const editor = document.getElementById('editorContent');
            if (editor) {
                editor.focus();
                document.execCommand('insertText', false, ' [New Text] ');
            }
        }

        function addImage() {
            showToast('Image insertion would open gallery in mobile app', 'info');
        }

        function convertTo(format) {
            showToast(`Converting to ${format.toUpperCase()}... (Demo mode)`, 'success');
        }

        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            document.body.setAttribute('data-theme', isDarkTheme ? 'dark' : 'light');
            localStorage.setItem('theme', isDarkTheme ? 'dark' : 'light');
            
            const btn = document.getElementById('themeBtn');
            btn.innerHTML = isDarkTheme ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            
            showToast(isDarkTheme ? 'Dark mode enabled' : 'Light mode enabled', 'success');
        }

        function checkTheme() {
            const saved = localStorage.getItem('theme');
            if (saved === 'light') {
                isDarkTheme = false;
                document.body.setAttribute('data-theme', 'light');
                document.getElementById('themeBtn').innerHTML = '<i class="fas fa-moon"></i>';
            }
        }

        function showHelp() {
            showToast('Tap features to edit PDF • Select pages for specific operations', 'info');
        }

        // Recent Files Functions - Fixed
        function loadRecentFiles() {
            try {
                const recent = JSON.parse(localStorage.getItem('recentPDFs') || '[]');
                const list = document.getElementById('fileList');
                
                if (recent.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-folder-open"></i>
                            <p>No recent files</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = recent.map((file, index) => `
                    <div class="file-item" onclick="loadRecentFile(${index})">
                        <div class="file-info">
                            <div class="file-icon">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <div class="file-meta">
                                <h4>${file.name}</h4>
                                <p>${file.pages} pages • ${new Date(file.date).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <button class="btn btn-icon btn-secondary" onclick="event.stopPropagation(); deleteRecentFile(${index})" style="width: 32px; height: 32px;">
                            <i class="fas fa-trash" style="font-size: 0.875rem;"></i>
                        </button>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Error loading recent files:', e);
            }
        }

        async function loadRecentFile(index) {
            if (isProcessing) return;
            
            try {
                const recent = JSON.parse(localStorage.getItem('recentPDFs') || '[]');
                if (!recent[index] || !recent[index].data) {
                    showToast('File data not available', 'error');
                    return;
                }
                
                const fileData = recent[index];
                
                isProcessing = true;
                showLoading(true);
                
                // Convert stored array back to Uint8Array
                pdfBytes = new Uint8Array(fileData.data);
                
                // CRITICAL FIX: Clone buffer for pdf.js
                const bufferCopy = pdfBytes.buffer.slice(0);
                
                // Load PDF
                const pdf = await pdfjsLib.getDocument({ data: bufferCopy }).promise;
                currentPDF = pdf;
                
                // Create a fake file object for display
                const fakeFile = {
                    name: fileData.name,
                    size: fileData.size
                };
                
                displayPDFInfo(fakeFile, pdf.numPages);
                await renderPageThumbnails(pdf);
                showWorkspace();
                
                document.getElementById('featuresGrid').style.display = 'grid';
                showToast(`Loaded ${fileData.name} from recent files`, 'success');
            } catch (error) {
                console.error('Error loading recent file:', error);
                showToast('Error loading file from storage: ' + error.message, 'error');
                currentPDF = null;
                pdfBytes = null;
            } finally {
                showLoading(false);
                isProcessing = false;
            }
        }

        function deleteRecentFile(index) {
            try {
                let recent = JSON.parse(localStorage.getItem('recentPDFs') || '[]');
                recent.splice(index, 1);
                localStorage.setItem('recentPDFs', JSON.stringify(recent));
                loadRecentFiles();
                showToast('File removed from recent', 'success');
            } catch (e) {
                console.error('Error deleting recent file:', e);
            }
        }

        // Bottom Sheet for Mobile
        function openBottomSheet(content) {
            document.getElementById('sheetContent').innerHTML = content;
            document.getElementById('bottomSheet').classList.add('active');
            document.getElementById('sheetOverlay').classList.add('active');
        }

        function closeBottomSheet() {
            document.getElementById('bottomSheet').classList.remove('active');
            document.getElementById('sheetOverlay').classList.remove('active');
        }

        // Handle merge file
        async function handleMergeFile(input) {
            if (input.files.length === 0) return;
            
            const file = input.files[0];
            showToast(`Added ${file.name} to merge queue`, 'success');
            
            const list = document.getElementById('mergeList');
            const div = document.createElement('div');
            div.style.cssText = 'display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--input-bg); border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid var(--border);';
            div.innerHTML = `
                <i class="fas fa-file-pdf" style="color: #ef4444;"></i>
                <span style="flex: 1; color: var(--text);">${file.name}</span>
                <button class="btn btn-icon btn-secondary" style="width: 32px; height: 32px;" onclick="this.parentElement.remove()">
                    <i class="fas fa-times" style="font-size: 0.875rem;"></i>
                </button>
            `;
            list.appendChild(div);
            
            // Reset merge input
            input.value = '';
        }
    </script>
</body>
</html>